<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Challenges</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Quill Rich Text Editor CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-XXXXXXXXXX'); // <-- PASTE YOUR MEASUREMENT ID HERE
    </script>
    <style>
        body { font-family: 'Poppins', sans-serif; transition: background-color 0.5s ease; }
        
        /* Styles for rich text content in light mode */
        .description-content { color: #374151; }
        .description-content ul { list-style: disc inside; padding-left: 1rem; margin-bottom: 1rem; }
        .description-content ol { list-style: decimal inside; padding-left: 1rem; margin-bottom: 1rem; }
        .description-content li { padding-left: 1rem; margin-bottom: 0.5rem; }
        .description-content li.ql-indent-1 { margin-left: 2.5rem; }
        .description-content li.ql-indent-2 { margin-left: 5rem; }

        .description-content p { margin-bottom: 1rem; color: #374151; }
        .description-content strong { font-weight: bold; color: #111827; }
        .description-content em { font-style: italic; }
        .description-content h1, .description-content h2 { font-size: 1.25rem; font-weight: bold; color: #111827; margin-bottom: 0.5rem; }
        
        /* Quill editor styling for light mode */
        .ql-toolbar { border-radius: 0.5rem 0.5rem 0 0; border-color: #d1d5db !important; }
        .ql-container { border-radius: 0 0 0.5rem 0.5rem; border-color: #d1d5db !important; min-height: 120px; font-size: 0.875rem; }

        /* Base styles for challenge cards */
        .challenge-card {
            border: 1px solid #e5e7eb; /* Default gray border */
        }

        /* Styles for expanding/collapsing challenge cards */
        .challenge-header {
            cursor: pointer;
        }
        .challenge-body {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            padding-top: 0;
            padding-bottom: 0;
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out, padding-top 0.5s ease-in-out, padding-bottom 0.5s ease-in-out;
        }
        .challenge-card.is-expanded .challenge-body {
            max-height: 3000px; /* High value for smooth opening */
            opacity: 1;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }

        /* Styles for completed challenges */
        .challenge-card.is-completed {
            background-color: #F0FFF4; /* Light green */
            border-color: #48BB78; /* Green border */
        }
        .challenge-card.is-completed .rank-indicator {
            background-color: #22C55E !important; /* Green */
            color: white !important;
        }
        .complete-btn.is-completed {
            color: #22C55E !important; /* Green */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">
    <div class="w-full max-w-5xl mx-auto p-4 py-12">
        <header id="page-header" class="relative text-center mb-12 transition-all duration-500 border-b-4 pb-4 rounded-lg">
            <h1 id="topic-title" class="text-3xl md:text-4xl font-bold">Loading Challenges...</h1>
            <p id="topic-subtitle" class="text-sm text-gray-600 mt-2"></p>
            <div class="flex justify-center items-center gap-6 mt-4">
                <a href="index.html" class="text-xs text-gray-500 hover:text-gray-800 transition">&larr; Back to Home</a>
            </div>
        </header>

        <main id="challenges-container" class="space-y-4">
            <div id="loading-spinner" class="text-center"><p class="text-base text-gray-600">Fetching challenges from the database...</p></div>
        </main>
    </div>

    <!-- Edit Password Modal -->
    <div id="edit-auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden"><div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-sm"><h2 class="text-xl font-bold text-gray-900 mb-4">Admin Access Required</h2><p class="text-gray-600 text-sm mb-6">Enter password to edit this challenge.</p><form id="edit-auth-form" class="flex flex-col gap-4"><input type="password" id="edit-auth-password" class="bg-gray-200 border-gray-400 text-sm rounded-lg p-2.5 text-center" placeholder="Password" required><div class="flex gap-4"><button type="button" id="cancel-edit-auth-btn" class="w-full text-gray-800 bg-gray-200 hover:bg-gray-300 font-medium rounded-lg text-sm px-5 py-2.5">Cancel</button><button type="submit" class="w-full text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5">Continue</button></div><p id="edit-auth-error" class="text-red-500 text-sm mt-2 h-4"></p></form></div></div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl relative max-h-[90vh]">
            <button id="close-edit-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            <h2 class="text-xl font-bold text-gray-900 mb-6">Edit Challenge</h2>
            <form id="edit-challenge-form" class="space-y-4 overflow-y-auto max-h-[75vh] pr-4">
                <input type="hidden" id="edit-challenge-id">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2"><label for="edit-challenge-title" class="block mb-2 text-sm font-medium text-gray-700">Challenge Title</label><input type="text" id="edit-challenge-title" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" required></div>
                    <div><label for="edit-challenge-rank" class="block mb-2 text-sm font-medium text-gray-700">Rank</label><input type="number" id="edit-challenge-rank" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" required></div>
                </div>
                <div><label for="edit-topic-select" class="block mb-2 text-sm font-medium text-gray-700">Topic</label><select id="edit-topic-select" name="topic" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" required><option value="sequence">Sequence</option><option value="selection">Selection</option><option value="iteration">Iteration</option><option value="data-structures">Data Structures</option><option value="string-manipulation">String Manipulation</option><option value="file-handling">File Handling</option><option value="subprograms">Subprograms</option><option value="exam-questions">Exam Questions</option></select></div>
                <div><label for="edit-description" class="block mb-2 text-sm font-medium text-gray-700">Challenge Description</label><div id="edit-description" class="bg-white"></div></div>
                <div><label class="block mb-2 text-sm font-medium text-gray-700">Commands Used</label><div id="edit-commands-checkboxes" class="grid grid-cols-2 sm:grid-cols-4 gap-4 bg-gray-50 p-4 rounded-lg border border-gray-300"></div></div>
                <fieldset class="border border-gray-300 p-4 rounded-lg">
                    <legend class="text-sm font-medium text-gray-700 px-2">Testing Table</legend>
                    <div id="edit-testing-table" class="space-y-4"></div>
                </fieldset>
                <div><label for="edit-screen-output" class="block mb-2 text-sm font-medium text-gray-700">Expected Screen Output</label><textarea id="edit-screen-output" rows="3" class="bg-gray-50 border border-gray-300 text-gray-900 text-xs rounded-lg block w-full p-2.5 font-mono"></textarea></div>
                <div><label for="edit-solution" class="block mb-2 text-sm font-medium text-gray-700">Solution Code</label><textarea id="edit-solution" rows="4" class="bg-gray-50 border border-gray-300 text-gray-900 text-xs rounded-lg block w-full p-2.5 font-mono"></textarea></div>
                <div class="flex justify-end gap-4 pt-4"><button type="button" id="cancel-edit-btn" class="text-gray-800 bg-gray-200 hover:bg-gray-300 font-medium rounded-lg text-sm px-5 py-2.5">Cancel</button><button type="submit" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5">Save Changes</button></div>
                <p id="edit-error" class="text-red-500 text-sm text-right h-4"></p>
            </form>
        </div>
    </div>
    
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script> const firebaseConfig = { apiKey: "AIzaSyDWfJRQhNUgktjIQaFVsoAqhsZtUQD3fpQ", authDomain: "cs-challenges-website.firebaseapp.com", projectId: "cs-challenges-website", storageBucket: "cs-challenges-website.firebasestorage.app", messagingSenderId: "1062820761218", appId: "1:1062820761218:web:ab4382d3f981d3f586ee9b" }; </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, where, orderBy, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        let db, quillEdit;
        let localChallenges = [];
        let challengeToEditId = null;

        const challengesContainer = document.getElementById('challenges-container');
        
        const editModal = document.getElementById('edit-modal');
        const editAuthModal = document.getElementById('edit-auth-modal');

        const TOPIC_STYLES = {
            'sequence': { name: 'Sequence', description: 'Challenges based on executing statements in order.', colorClasses: { title: 'text-red-600', border: 'border-red-500', bg: 'bg-red-50' } },
            'selection': { name: 'Selection', description: 'Using if, else, and switch to control program flow.', colorClasses: { title: 'text-orange-600', border: 'border-orange-500', bg: 'bg-orange-50' } },
            'iteration': { name: 'Iteration', description: 'Challenges involving loops (for, while).', colorClasses: { title: 'text-yellow-600', border: 'border-yellow-500', bg: 'bg-yellow-50' } },
            'data-structures': { name: 'Data Structures', description: 'Working with 1D and 2D arrays.', colorClasses: { title: 'text-green-600', border: 'border-green-500', bg: 'bg-green-50' } },
            'string-manipulation': { name: 'String Manipulation', description: 'Working with text, substrings, and concatenation.', colorClasses: { title: 'text-teal-600', border: 'border-teal-500', bg: 'bg-teal-50' } },
            'file-handling': { name: 'File Handling', description: 'Reading from and writing to external files.', colorClasses: { title: 'text-blue-600', border: 'border-blue-500', bg: 'bg-blue-50' } },
            'subprograms': { name: 'Subprograms', description: 'Creating and using functions and procedures.', colorClasses: { title: 'text-violet-600', border: 'border-violet-500', bg: 'bg-violet-50' } },
            'exam-questions': { name: 'Exam Questions', description: 'Practice questions in a typical exam style.', colorClasses: { title: 'text-indigo-600', border: 'border-indigo-500', bg: 'bg-indigo-50' } },
            'default': { name: 'Challenges', description: 'A collection of challenges.', colorClasses: { title: 'text-slate-600', border: 'border-slate-500', bg: 'bg-slate-50' } }
        };
        
        const COMMAND_DATA_TEXT = `
            print()
            #EF4444

            input()
            #EF4444

            len()
            #EF4444

            randint()
            #EF4444

            Concatenation
            #14B8A6

            Sub-string
            #14B8A6

            MOD
            #EF4444

            DIV
            #EF4444

            1D Array
            #22C55E

            2D Array
            #22C55E

            if
            #F97316

            if/else
            #F97316

            if/elif/else
            #F97316

            AND/OR/NOT
            #F97316

            for
            #EAB308

            while
            #EAB308

            file.readline()
            #3B82F6

            file.writelines()
            #3B82F6

            Procedures
            #6366F1

            Functions
            #6366F1
        `;

        function escapeHTML(str) { return str.replace(/[&<>"']/g, match => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[match]); }
        function parseCommandData(text) { const commandObject = {}; const entries = text.trim().split(/\n\s*\n/); entries.forEach(entry => { const lines = entry.trim().split('\n'); const name = lines[0].trim(); const color = lines[1].trim(); const example = lines.slice(2).join('\n'); const key = name.replace(/\(\)/g, '').toLowerCase(); commandObject[key] = { name, color, example }; }); return commandObject; }
        const COMMAND_DATA = parseCommandData(COMMAND_DATA_TEXT);

        function getTopicFromURL() { return new URLSearchParams(window.location.search).get('topic') || 'default'; }
        
        function applyTheme(topic) {
            const style = TOPIC_STYLES[topic] || TOPIC_STYLES.default;
            const titleEl = document.getElementById('topic-title');
            const subtitleEl = document.getElementById('topic-subtitle');
            const headerEl = document.getElementById('page-header');

            titleEl.textContent = style.name;
            titleEl.className = `text-3xl md:text-4xl font-bold ${style.colorClasses.title}`;
            subtitleEl.textContent = style.description;

            // Remove any existing border color classes
            headerEl.className = headerEl.className.replace(/border-\S+-500/g, '');
            headerEl.classList.add(style.colorClasses.border);

            // Remove any existing background color classes and add the new one
            document.body.className = document.body.className.replace(/bg-\S+-\d+/g, '');
            document.body.classList.add(style.colorClasses.bg);
        }
        
        function openModal(modal) { modal.classList.remove('hidden'); }
        function closeModal(modal) { modal.classList.add('hidden'); }

        function renderChallenges(challenges) {
            localChallenges = challenges;
            challengesContainer.innerHTML = ''; 
            if (challenges.length === 0) {
                challengesContainer.innerHTML = `<p class="text-center text-gray-600">No challenges found for this topic.</p>`;
                return;
            }
            challenges.forEach((challenge, index) => {
                const commandTags = (challenge.commandsUsed || '').split(',').map(cmd => cmd.trim().toLowerCase()).filter(Boolean).map(cmdKey => {
                    const commandInfo = COMMAND_DATA[cmdKey.replace(/\(\)/g, '').replace('sub-string', 'sub-string')] || COMMAND_DATA[cmdKey];
                    return commandInfo ? `<span class="font-semibold" style="color: ${commandInfo.color};">${commandInfo.name}</span>` : `<span>${cmdKey}</span>`;
                }).join(', ');
                
                const testingTableRows = (challenge.testingTable || []).map(row => `
                    <tr class="border-b border-gray-200">
                        <td class="p-2">${escapeHTML(row.test || '')}</td>
                        <td class="p-2">${escapeHTML(row.input || '')}</td>
                        <td class="p-2">${escapeHTML(row.output || '')}</td>
                    </tr>
                `).join('');
                
                const testingTableHTML = testingTableRows ? `
                    <div class="mb-6">
                        <h3 class="font-semibold text-base text-gray-800 mb-2">Testing Table</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs text-left text-gray-700 bg-gray-100 rounded-md">
                                <thead class="bg-gray-200 text-xs uppercase">
                                    <tr>
                                        <th class="p-2">Test</th>
                                        <th class="p-2">Input</th>
                                        <th class="p-2">Output</th>
                                    </tr>
                                </thead>
                                <tbody>${testingTableRows}</tbody>
                            </table>
                        </div>
                    </div>` : '';

                const style = TOPIC_STYLES[getTopicFromURL()] || TOPIC_STYLES.default;
                const isCompleted = localStorage.getItem(`challenge-completed-${challenge.id}`) === 'true';

                const challengeElement = document.createElement('div');
                challengeElement.className = `challenge-card bg-white rounded-lg shadow-lg overflow-hidden relative transition-all duration-500 ${isCompleted ? 'is-completed' : ''}`;
                challengeElement.id = `challenge-${challenge.id}`;
                challengeElement.innerHTML = `
                    <div class="absolute top-4 right-4 flex gap-2">
                         <button class="complete-btn ${isCompleted ? 'is-completed' : ''} text-gray-400 hover:text-green-500 transition-colors" title="Mark as complete" data-id="${challenge.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                        </button>
                        <button class="edit-challenge-btn text-gray-400 hover:text-blue-600 transition-colors" title="Edit Challenge" data-id="${challenge.id}"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                    </div>
                    <div class="p-6">
                        <div class="challenge-header flex items-start">
                             <div class="rank-indicator ${isCompleted ? 'is-completed' : ''} flex-shrink-0 mr-4 h-10 w-10 bg-gray-200 rounded-full flex items-center justify-center transition-colors duration-300">
                                <span class="font-bold text-lg text-gray-700">${challenge.rank || 0}</span>
                            </div>
                            <div class="flex-grow">
                                <h2 class="text-xl font-bold mb-1 ${style.colorClasses.title}">${challenge.title}</h2>
                                ${commandTags ? `<div class="text-xs text-gray-500">Commands Used: ${commandTags}</div>` : ''}
                            </div>
                        </div>
                        <div class="challenge-body pl-14">
                            <div class="text-sm text-gray-700 mb-6 description-content">${challenge.description}</div>
                            ${testingTableHTML}
                            <div class="mb-6"><h3 class="font-semibold text-base text-gray-800 mb-2">Expected Screen Output</h3><pre class="bg-gray-200 text-gray-800 rounded-md p-4 font-mono text-xs">${challenge.screenOutput || 'N/A'}</pre></div>
                            <div><h3 class="font-semibold text-base text-gray-800 mb-2">Solution</h3><div class="solution-container" id="solution-${index}"><div class="password-gate flex items-center gap-2"><input type="password" placeholder="Enter password to view" class="bg-gray-200 border border-gray-400 text-sm rounded-lg p-2 w-full max-w-xs"><button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Show</button></div><pre class="solution-code bg-gray-200 text-gray-800 rounded-md p-4 font-mono text-xs hidden mt-2"></pre></div></div>
                        </div>
                    </div>`;
                challengesContainer.appendChild(challengeElement);
                const solContainer = challengeElement.querySelector(`#solution-${index}`);
                solContainer.querySelector('button').addEventListener('click', () => {
                    const passInput = solContainer.querySelector('input[type="password"]');
                    if (passInput.value === '90210') {
                        solContainer.querySelector('.solution-code').textContent = challenge.solution || 'No solution.';
                        solContainer.querySelector('.solution-code').classList.remove('hidden');
                        solContainer.querySelector('.password-gate').classList.add('hidden');
                    } else { passInput.value = ''; passInput.placeholder = 'Incorrect password!';}
                });
            });
        }
        
        async function fetchAndRenderChallenges() {
            challengesContainer.innerHTML = `<div id="loading-spinner" class="text-center"><p class="text-lg text-gray-600">Fetching...</p></div>`;
            const topic = getTopicFromURL();
            try {
                 const q = query(collection(db, 'challenges'), where("topic", "==", topic), orderBy("rank", "asc"));
                 const querySnapshot = await getDocs(q);
                 const challenges = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 renderChallenges(challenges);
            } catch (error) { console.error("Error fetching challenges:", error); challengesContainer.innerHTML = `<p class="text-center text-red-500">Could not load challenges.</p>`; }
        }
        
        async function handleEditUpdate(e) {
            e.preventDefault();
            const challengeId = document.getElementById('edit-challenge-id').value;
            const selectedCommands = Array.from(document.querySelectorAll('#edit-commands-checkboxes input:checked')).map(cb => cb.value);
            
            const testingTable = [];
            for (let i = 1; i <= 3; i++) {
                const test = document.getElementById(`edit-test-${i}`).value;
                const input = document.getElementById(`edit-input-${i}`).value;
                const output = document.getElementById(`edit-output-${i}`).value;
                if (test || input || output) {
                    testingTable.push({ test, input, output });
                }
            }
            
            const updatedData = { 
                title: document.getElementById('edit-challenge-title').value,
                rank: parseInt(document.getElementById('edit-challenge-rank').value, 10) || 0,
                topic: document.getElementById('edit-topic-select').value,
                description: quillEdit.root.innerHTML, 
                commandsUsed: selectedCommands.join(', '), 
                testingTable: testingTable,
                screenOutput: document.getElementById('edit-screen-output').value, 
                solution: document.getElementById('edit-solution').value, 
            };
            try {
                await updateDoc(doc(db, 'challenges', challengeId), updatedData);
                closeModal(editModal);
                fetchAndRenderChallenges();
            } catch (error) { console.error("Error updating document: ", error); document.getElementById('edit-error').textContent = 'Failed to save.'; }
        }

        function openEditAuthModal(challengeId) {
            challengeToEditId = challengeId;
            const passwordInput = document.getElementById('edit-auth-password');
            passwordInput.value = '';
            document.getElementById('edit-auth-error').textContent = '';
            openModal(editAuthModal);
            passwordInput.focus();
        }

        function handleEditAuthConfirm(e) {
            e.preventDefault();
            const passwordInput = document.getElementById('edit-auth-password');
            if (passwordInput.value === 'Nintendo1') {
                closeModal(editAuthModal);
                openEditModal(challengeToEditId);
                challengeToEditId = null;
            } else {
                document.getElementById('edit-auth-error').textContent = 'Incorrect password.';
            }
        }

        function openEditModal(challengeId) {
            const challenge = localChallenges.find(c => c.id === challengeId);
            if (!challenge) return;
            document.getElementById('edit-challenge-id').value = challenge.id;
            document.getElementById('edit-challenge-title').value = challenge.title;
            document.getElementById('edit-challenge-rank').value = challenge.rank || 0;
            document.getElementById('edit-topic-select').value = challenge.topic;
            quillEdit.root.innerHTML = challenge.description || '';
            document.getElementById('edit-screen-output').value = challenge.screenOutput || '';
            document.getElementById('edit-solution').value = challenge.solution || '';
            document.getElementById('edit-error').textContent = '';
            
            const testingTableContainer = document.getElementById('edit-testing-table');
            testingTableContainer.innerHTML = '';
            for (let i = 1; i <= 3; i++) {
                const rowData = (challenge.testingTable && challenge.testingTable[i-1]) ? challenge.testingTable[i-1] : {};
                const row = document.createElement('div');
                row.className = 'grid grid-cols-1 md:grid-cols-3 gap-4';
                row.innerHTML = `
                    <input type="text" id="edit-test-${i}" class="bg-gray-50 border-gray-300 text-sm rounded-lg p-2" placeholder="Test ${i}" value="${escapeHTML(rowData.test || '')}">
                    <input type="text" id="edit-input-${i}" class="bg-gray-50 border-gray-300 text-sm rounded-lg p-2" placeholder="Input ${i}" value="${escapeHTML(rowData.input || '')}">
                    <input type="text" id="edit-output-${i}" class="bg-gray-50 border-gray-300 text-sm rounded-lg p-2" placeholder="Output ${i}" value="${escapeHTML(rowData.output || '')}">
                `;
                testingTableContainer.appendChild(row);
            }

            const usedCommands = (challenge.commandsUsed || '').split(',').map(c => c.trim());
            document.querySelectorAll('#edit-commands-checkboxes input').forEach(cb => { cb.checked = usedCommands.includes(cb.value); });
            openModal(editModal);
        }
        
        function setupModals() {
            const editCommandsContainer = document.getElementById('edit-commands-checkboxes');
            editCommandsContainer.innerHTML = Object.values(COMMAND_DATA).map(cmd => `
                <div class="flex items-center">
                    <input id="edit-cmd-${cmd.name}" type="checkbox" value="${cmd.name}" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                    <label for="edit-cmd-${cmd.name}" class="ml-2 text-sm font-medium" style="color: ${cmd.color};">${cmd.name}</label>
                </div>
            `).join('');
            
            document.getElementById('close-edit-btn').addEventListener('click', () => closeModal(editModal));
            document.getElementById('cancel-edit-btn').addEventListener('click', () => closeModal(editModal));
            document.getElementById('edit-challenge-form').addEventListener('submit', handleEditUpdate);
            document.getElementById('edit-auth-form').addEventListener('submit', handleEditAuthConfirm);
            document.getElementById('cancel-edit-auth-btn').addEventListener('click', () => closeModal(editAuthModal));
        }

        async function main() {
            applyTheme(getTopicFromURL());
            try {
                 const app = initializeApp(firebaseConfig);
                 db = getFirestore(app);
                 await signInAnonymously(getAuth(app));
                 await fetchAndRenderChallenges();
            } catch (error) { console.error("Firebase Init Error:", error); challengesContainer.innerHTML = `<p class="text-center text-red-500">Could not connect.</p>`; }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            quillEdit = new Quill('#edit-description', { theme: 'snow', modules: { toolbar: [[ 'bold', 'italic', 'underline' ], [{ 'list': 'ordered'}, { 'list': 'bullet' }], [{ 'indent': '-1'}, { 'indent': '+1' }]] } });
            main();
            setupModals();
            
            challengesContainer.addEventListener('click', e => {
                const editBtn = e.target.closest('.edit-challenge-btn');
                const completeBtn = e.target.closest('.complete-btn');
                const header = e.target.closest('.challenge-header');

                if (editBtn) {
                    e.stopPropagation(); // Prevent card from expanding when clicking edit
                    openEditAuthModal(editBtn.dataset.id);
                    return; 
                }
                
                if (completeBtn) {
                    e.stopPropagation(); // Prevent card from expanding when clicking complete
                    const challengeId = completeBtn.dataset.id;
                    const card = completeBtn.closest('.challenge-card');
                    if (!card) return;

                    const rankIndicator = card.querySelector('.rank-indicator');
                    
                    const isNowCompleted = card.classList.toggle('is-completed');
                    rankIndicator.classList.toggle('is-completed', isNowCompleted);
                    completeBtn.classList.toggle('is-completed', isNowCompleted);

                    if (isNowCompleted) {
                        localStorage.setItem(`challenge-completed-${challengeId}`, 'true');
                    } else {
                        localStorage.removeItem(`challenge-completed-${challengeId}`);
                    }
                    return;
                }

                if (header) {
                    const card = header.closest('.challenge-card');
                    if (card) {
                        card.classList.toggle('is-expanded');
                    }
                }
            });
        });
    </script>
</body>
</html>

